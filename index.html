<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Inventario SKU (Vanguardista)</title>
ย ย <!-- Carga de Tailwind CSS -->
ย ย <script src="https://cdn.tailwindcss.com"></script>
ยย ย
ย ย <!-- Librerรญas para exportar a PDF -->
ย ย <!-- Se mantiene html2canvas por si se necesita para grรกficos futuros, pero se ignora para la tabla -->
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
ย ย <!-- NUEVA LIBRERรA: jsPDF-AutoTable para generaciรณn de tablas vectoriales de alta calidad -->
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
ย ย <!-- Carga de Lucide Icons (para el icono de exportaciรณn) -->
ย ย <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
ยย ย
ย ย <style>
ย ย ย ย /* Definiciรณn de la paleta de colores Vanguardista */
ย ย ย ย .color-primary-green { background-color: #577161; } /* Verde Olivo Oscuro (Accento principal) */
ย ย ย ย .color-primary-hover { background-color: #3E4D45; } /* Verde mรกs oscuro (Hover) */
ย ย ย ย .color-text-dark { color: #3C3231; } /* Marrรณn Espresso (Texto principal) */
ย ย ย ย .color-card-bg { background-color: #FFFFFF; } /* Fondo de Tarjeta */
ย ย ย ย .color-base-bg { background-color: #F7F7F7; } /* Fondo de la aplicaciรณn */
ย ย ย ย .color-border { border-color: #E5E5E5; } /* Borde suave */
ยย ย ย ย
ย ย ย ย body { font-family: 'Inter', sans-serif; }
ยย ย ย ย
ย ย ย ย /* Ocultar barra de desplazamiento en la tabla para estรฉtica */
ย ย ย ย .scrollable-table::-webkit-scrollbar { display: none; }
ย ย ย ย .scrollable-table { -ms-overflow-style: none; scrollbar-width: none; }
ยย ย ย ย
ย ย ย ย /* Estilo del Canvas */
ย ย ย ย #ventasPieCanvas {ย
ย ย ย ย ย ย /* Se hace mรกs ancho para acomodar el grรกfico y la leyenda */
ย ย ย ย ย ย max-width: 100%;ย
ย ย ย ย ย ย height: auto;ย
ย ย ย ย }
ย ย ย ย #stockCanvas { border: 1px solid #E5E5E5; border-radius: 12px; }
ยย ย ย ย
ย ย ย ย /* Clases de Mensajes basadas en la paleta */
ย ย ย ย .success { background-color: #A5C9B3; color: #3E4D45; border: 1px solid #88A796; } /* Verde claro */
ย ย ย ย .error { background-color: #ffe0e0; color: #9a1f26; border: 1px solid #ffb3b3; } /* Rojo estรกndar, contrastante */
ยย ย ย ย
ย ย ย ย /* Estilo para el input de archivo - Moderno */
ย ย ย ย #csv-file-input::-webkit-file-upload-button {
ย ย ย ย ย ย visibility: hidden;
ย ย ย ย }
ย ย ย ย #csv-file-input::before {
ย ย ย ย ย ย content: 'Seleccionar Archivo CSV';
ย ย ย ย ย ย display: inline-block;
ย ย ย ย ย ย background: #f0f0f0;
ย ย ย ย ย ย border: 1px solid #ddd;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย padding: 10px 20px;
ย ย ย ย ย ย outline: none;
ย ย ย ย ย ย white-space: nowrap;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย color: #3C3231;
ย ย ย ย }
ย ย ย ย #csv-file-input:hover::before {
ย ย ย ย ย ย border-color: #577161;
ย ย ย ย ย ย background: #e9e9e9;
ย ย ย ย }
ยย ย ย ย
ย ย ย ย /* Sombra personalizada para un efecto 'impactante y sutil' (tipo Apple) */
ย ย ย ย .shadow-custom {
ย ย ย ย ย ย box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.05);
ย ย ย ย }
ย ย ย ย .hover\:shadow-custom:hover {
ย ย ย ย ย ย box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12), 0 6px 15px rgba(0, 0, 0, 0.07);
ย ย ย ย }

ย ย ย ย /* Modal y Overlays */
ย ย ย ย .modal-overlay {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย top: 0;
ย ย ย ย ย ย left: 0;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย height: 100%;
ย ย ย ย ย ย background: rgba(0, 0, 0, 0.5);
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย z-index: 1000;
ย ย ย ย }
ย ย ย ย .modal-content {
ย ย ย ย ย ย background: white;
ย ย ย ย ย ย padding: 2rem;
ย ย ย ย ย ย border-radius: 1rem;
ย ย ย ย ย ย box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
ย ย ย ย ย ย width: 90%;
ย ย ย ย ย ย max-width: 400px;
ย ย ย ย }
ย ย </style>
</head>
<body class="color-base-bg color-text-dark">
ย ย <!-- Inicializar iconos de Lucide al cargar la pรกgina -->
ย ย <script>
ย ย ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย ย ย if (window.lucide) {
ย ย ย ย ย ย ย ย window.lucide.createIcons();
ย ย ย ย ย ย }
ย ย ย ย });
ย ย </script>
ย ย <div class="container max-w-7xl mx-auto p-4 md:p-10">

ย ย ย ย <!-- HEADER CARD (Modern Apple Style - Impactante y Sutil) -->
ย ย ย ย <div class="color-card-bg p-8 shadow-custom rounded-3xl mb-12 border color-border transition-all duration-300 transform hover:shadow-custom">
ย ย ย ย ย ย <header class="text-center">
ย ย ย ย ย ย ย ย <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight bg-clip-text text-transparent"
ย ย ย ย ย ย ย ย ย ย style="background-image: linear-gradient(135deg, #3E4D45, #577161);">
ย ย ย ย ย ย ย ย ย ย Inventario SKUs <span class="text-green-600">๐ฟ</span>
ย ย ย ย ย ย ย ย </h1>
ย ย ย ย ย ย ย ย <p class="text-xl text-gray-600 mt-3 font-light max-w-2xl mx-auto">
ย ย ย ย ย ย ย ย ย ย Gestiรณn de stock en tiempo ArMaly
ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย </header>
ย ย ย ย </div>
ยย ย ย ย
ย ย ย ย <!-- Tarjeta PASO 1: CARGA DE ARCHIVO -->
ย ย ย ย <div id="file-upload-card" class="color-card-bg p-8 shadow-xl rounded-2xl mb-10 border color-border">
ย ย ย ย ย ย <h2 class="text-2xl font-semibold mb-5 text-gray-800">1. Carga de Inventario (.CSV)</h2>
ย ย ย ย ย ย <p class="text-gray-600 mb-5 text-base">La estructura requerida es: <code class="bg-gray-100 p-1 rounded-md text-sm">SKU, Nombre, Descripciรณn Larga, Stock Inicial, Stock Vendido, Precio Venta</code>.</p>
ย ย ย ย ย ย <input type="file" id="csv-file-input" accept=".csv" class="w-full p-3 border color-border rounded-lg focus:border-green-700 transition duration-150" />
ย ย ย ย ย ย <div id="mensaje-carga" class="message-box mt-5 p-4 rounded-xl font-medium"></div>
ย ย ย ย </div>

ย ย ย ย <!-- CONTENIDO PRINCIPAL DE LA APLICACIรN (OCULTO HASTA QUE SE CARGUEN LOS DATOS) -->
ย ย ย ย <div id="main-app-content" class="hidden">
ย ย ย ย ย ย <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย <!-- Tarjeta Principal: VENTA RรPIDA -->
ย ย ย ย ย ย ย ย <div id="venta-area" class="color-card-bg p-8 shadow-xl rounded-2xl lg:col-span-2 border color-border">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-gray-800 mb-5">2. Venta Rรกpida / Consulta</h2>
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย <input type="text" id="sku-input" placeholder="Ingresa el SKU (ej. 1, 2 o 3) para consultar y agregar." autofocus
ย ย ย ย ย ย ย ย ย ย ย ย class="w-full p-4 text-xl border color-border rounded-xl focus:border-green-700 focus:ring-1 focus:ring-[#577161] transition duration-150 mb-5 text-gray-700">
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย <button onclick="registrarVentaDesdeInput()"
ย ย ย ย ย ย ย ย ย ย ย ย class="flex items-center justify-center w-full py-4 color-primary-green text-white font-bold rounded-xl shadow-lg hover:color-primary-hover transition duration-200 active:bg-green-800 text-lg">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="mr-3 text-xl">๐</span> CONFIRMAR VENTA (+1)
ย ย ย ย ย ย ย ย ย ย </button>
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย <div id="consulta-resultado" class="result-box mt-6 p-4 bg-gray-50 border color-border rounded-xl text-base text-gray-700 min-h-[4rem]">
ย ย ย ย ย ย ย ย ย ย ย ย <!-- Resultado de la consulta se muestra aquรญ -->
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-500">Consulta el estado del producto ingresando un SKU.</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="mensaje" class="message-box mt-5 p-4 rounded-xl font-medium"></div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <!-- Tarjeta Secundaria: CANVAS (REPORTE VISUAL) -->
ย ย ย ย ย ย ย ย <div id="canvas-area" class="color-card-bg p-8 shadow-xl rounded-2xl border color-border">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-gray-800 mb-5">3. Stock Disponible (Visual)</h2>
ย ย ย ย ย ย ย ย ย ย <!-- Se muestra el รญndice inicial de los productos mostrados -->
ย ย ย ย ย ย ย ย ย ย <p id="visual-filter-info" class="text-sm text-gray-500 mb-3 text-center">Mostrando productos 1-10.</p>
ย ย ย ย ย ย ย ย ย ย <canvas id="stockCanvas" width="400" height="200" class="w-full"></canvas>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ยย ย ย ย ย ย
ย ย ย ย ย ย <!-- SECCIรN DE REPORTE DE VENTAS (Optimizaciรณn de Espacio Aplicada) -->
ย ย ย ย ย ย <div class="color-card-bg p-8 shadow-xl rounded-2xl mb-10 border color-border">
ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-gray-800 mb-6">4. Reporte Financiero y de Ventas</h2>
ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย <!-- Pie Chart Ventas con Leyenda a la Derecha (Optimizado) -->
ย ย ย ย ย ย ย ย ย ย <div class="lg:col-span-2 flex flex-col md:flex-row bg-gray-50 rounded-xl overflow-hidden p-3 border color-border">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex-grow">
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-medium mb-2 text-center text-gray-700 md:text-left md:ml-4 pt-1">Distribuciรณn de Ingresos por Producto</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-center items-center h-full relative p-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- El canvas ahora tiene espacio suficiente para el grรกfico Y la leyenda al lado -->
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <canvas id="ventasPieCanvas" width="500" height="250" class="w-full"></canvas>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <!-- Contenedor para Mรฉtricas Clave y Leyenda (al lado del Canvas) -->
ย ย ย ย ย ย ย ย ย ย ย ย <div class="w-full md:w-64 flex-shrink-0 p-4 border-t md:border-t-0 md:border-l color-border bg-white rounded-b-xl md:rounded-l-none md:rounded-r-xl">
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- BLOQUE DE MรTRICAS -->
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mb-6 text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600 font-medium text-sm mb-1">Ingreso Total</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span id="total-revenue-amount" class="font-bold text-3xl text-[#3E4D45] block">$0.00</span>
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- NUEVA MรTRICA: Ticket Promedio -->
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="ticket-promedio-display" class="mt-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-500 text-xs">Ticket Promedio:</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span id="ticket-promedio-amount" class="font-semibold text-lg text-gray-700 block">$0.00</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- FIN BLOQUE DE MรTRICAS -->

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="pie-legend-container" class="space-y-1 text-sm pt-4 border-t color-border">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- La leyenda se inyectarรก aquรญ en HTML -->
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-500 text-center">Datos de la leyenda...</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย <!-- Tabla de Ventas (Optimizado para ocupar el espacio restante) -->
ย ย ย ย ย ย ย ย ย ย <div class="lg:col-span-1 bg-gray-50 rounded-xl overflow-hidden p-3 border color-border">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-medium mb-4 text-center text-gray-700">Detalle de Ventas Histรณricas</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="overflow-x-auto scrollable-table max-h-96">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <table id="ventas-tabla" class="min-w-full divide-y divide-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-gray-100 sticky top-0">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Producto</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Cant.</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total ($)</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tbody class="bg-white divide-y divide-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- Datos de ventas aquรญ -->
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ยย ย ย ย ย ย
ย ย ย ย ย ย <!-- Tarjeta de la Tabla de Inventario -->
ย ย ย ย ย ย <div class="color-card-bg p-8 shadow-xl rounded-2xl border color-border">
ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-6">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-semibold text-gray-800">5. Inventario Detallado en Tiempo Real</h2>
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย <!-- BOTรN DE EXPORTACIรN A PDF (Minimalista y Sutil) -->
ย ย ย ย ย ย ย ย ย ย <!-- Usa un icono 'save' y colores de bajo contraste -->
ย ย ย ย ย ย ย ย ย ย <buttonย
ย ย ย ย ย ย ย ย ย ย ย ย onclick="mostrarModalContrasena()"
ย ย ย ย ย ย ย ย ย ย ย ย title="Exportar Reporte a PDF (Contraseรฑa: armaly)"
ย ย ย ย ย ย ย ย ย ย ย ย class="p-2 rounded-fullย
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย ย text-gray-400 bg-gray-50ย
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย ย transition-all duration-200ย
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย ย hover:text-gray-700 hover:bg-gray-200ย
ยย ย ย ย ย ย ย ย ย ย ย ย ย ย ย focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50"
ย ย ย ย ย ย ย ย ย ย >
ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="save" class="w-5 h-5"></i>
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย <!-- El ID inventario-data-container ya no es necesario para html2canvas, pero se mantiene para la estructura. -->
ย ย ย ย ย ย ย ย <div id="inventario-data-container">
ย ย ย ย ย ย ย ย ย ย <div class="overflow-x-auto scrollable-table max-h-[30rem]">
ย ย ย ย ย ย ย ย ย ย ย ย <table id="inventario-tabla" class="min-w-full divide-y divide-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-gray-100 sticky top-0">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">SKU</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nombre</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock Inicial</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Vendido</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock Disponible</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Precio</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tbody class="bg-white divide-y divide-gray-200 text-gray-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <!-- Los datos se inyectarรกn aquรญ con JavaScript -->
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <!-- Mensaje si la tabla estรก vacรญa -->
ย ย ย ย ย ย ย ย ย ย <p id="empty-message" class="text-center text-gray-500 py-6 hidden">No hay productos en el inventario.</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย </div>

ย ย <!-- MODAL DE CONTRASEรA (Oculto por defecto) -->
ย ย <div id="password-modal" class="modal-overlay hidden">
ย ย ย ย <div class="modal-content">
ย ย ย ย ย ย <h3 class="text-xl font-bold mb-4 text-gray-800">Exportar Inventario</h3>
ย ย ย ย ย ย <p class="text-gray-600 mb-4">Por favor, introduce la contraseรฑa de seguridad para exportar el reporte a PDF:</p>
ย ย ย ย ย ย <input type="password" id="password-input" placeholder="Contraseรฑa"
ยย ย ย ย ย ย ย ย ย class="w-full p-3 border color-border rounded-lg mb-4 focus:border-red-600 focus:ring-1 focus:ring-red-600 transition duration-150">
ย ย ย ย ย ย <div id="modal-error-message" class="text-red-500 text-sm mb-4 hidden"></div>
ยย ย ย ย ย ย
ย ย ย ย ย ย <div class="flex justify-end space-x-3">
ย ย ย ย ย ย ย ย <button onclick="ocultarModalContrasena()"
ย ย ย ย ย ย ย ย ย ย ย ย class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
ย ย ย ย ย ย ย ย ย ย Cancelar
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย <button onclick="verificarContrasenaExportar()"
ย ย ย ย ย ย ย ย ย ย ย ย class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">
ย ย ย ย ย ย ย ย ย ย Confirmar
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <script>
ย ย ย ย // --- Variables Globales ---
ย ย ย ย const STORAGE_KEY = 'inventario_skus_apple_mvp';
ย ย ย ย const MAX_VISUAL_ITEMS = 10; // Nuevo: Lรญmite de productos a mostrar en el grรกfico visual
ย ย ย ย let visualStartIndex = 0;ย ย // Nuevo: รndice inicial para el subconjunto de productos
ย ย ย ย let inventario = {};
ย ย ย ย const CORRECT_PASSWORD = 'armaly'; // Contraseรฑa para la exportaciรณn

ย ย ย ย // --- FUNCIONES DE PERSISTENCIA Y CARGA ---

ย ย ย ย /**
ยย ย ย ย * Parsea la cadena CSV y la convierte en el objeto inventario.
ยย ย ย ย */
ย ย ย ย function parsearCSV(csvText) {
ย ย ย ย ย ย const lines = csvText.trim().split('\n');
ย ย ย ย ย ย const data = {};

ย ย ย ย ย ย if (lines.length <= 1) return data; // No hay datos ademรกs de la cabecera

ย ย ย ย ย ย for (let i = 1; i < lines.length; i++) {
ย ย ย ย ย ย ย ย // Usamos una expresiรณn regular simple para manejar comas dentro de comillas
ย ย ย ย ย ย ย ย const values = lines[i].match(/(".*?"|[^,]+)/g);
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Asegurar que values no sea null y tenga suficientes elementos
ย ย ย ย ย ย ย ย if (values && values.length >= 6) {
ย ย ย ย ย ย ย ย ย ย const cleanValues = values.map(val => val.trim().replace(/"/g, ''));
ย ย ย ย ย ย ย ย ย ย const sku = cleanValues[0].toUpperCase();
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย data[sku] = {
ย ย ย ย ย ย ย ย ย ย ย ย nombre: cleanValues[1],
ย ย ย ย ย ย ย ย ย ย ย ย stock_inicial: parseInt(cleanValues[3], 10) || 0,ย
ย ย ย ย ย ย ย ย ย ย ย ย stock_vendido: parseInt(cleanValues[4], 10) || 0,ย
ย ย ย ย ย ย ย ย ย ย ย ย precio_venta: parseFloat(cleanValues[5]) || 0.00
ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ย return data;
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Carga el inventario de localStorage.
ยย ย ย ย * Decide si mostrar la aplicaciรณn o el formulario de carga.
ยย ย ย ย */
ย ย ย ย function cargarInventario() {
ย ย ย ย ย ย const storedData = localStorage.getItem(STORAGE_KEY);
ยย ย ย ย ย ย
ย ย ย ย ย ย if (storedData) {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย inventario = JSON.parse(storedData);
ย ย ย ย ย ย ย ย ย ย // Si se carga algo, mostrar la app
ย ย ย ย ย ย ย ย ย ย if (Object.keys(inventario).length > 0) {
ย ย ย ย ย ย ย ย ย ย ย ย // Reiniciar el รญndice visual al cargar
ย ย ย ย ย ย ย ย ย ย ย ย visualStartIndex = 0;ย
ยย ย ย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย ย ย mostrarMensaje('Inventario cargado desde la รบltima sesiรณn.', 'success');
ย ย ย ย ย ย ย ย ย ย ย ย toggleAppView(true);ย
ย ย ย ย ย ย ย ย ย ย ย ย renderizarTabla();
ย ย ย ย ย ย ย ย ย ย ย ย renderizarTablaVentas();
ย ย ย ย ย ย ย ย ย ย ย ย // Llamada con setTimeout para que Canvas tenga dimensiones correctas
ย ย ย ย ย ย ย ย ย ย ย ย setTimeout(() => {
ยย ย ย ย ย ย ย ย ย ย ย ย ย dibujarCanvasReporte();
ยย ย ย ย ย ย ย ย ย ย ย ย ย dibujarPieChartVentas();
ยย ย ย ย ย ย ย ย ย ย ย ย ย // Re-renderizar iconos de Lucide (si no se hizo automรกticamente)
ยย ย ย ย ย ย ย ย ย ย ย ย ย if (window.lucide) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย window.lucide.createIcons();
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย }, 50);ย
ย ย ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ย ย console.error("Error al parsear localStorage:", e);
ย ย ย ย ย ย ย ย ย ย // Ignorar error de JSON y forzar la carga por archivo
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ย // Si no hay datos vรกlidos, mostrar el formulario de carga
ย ย ย ย ย ย mostrarMensajeCarga('Por favor, carga un archivo CSV para iniciar el inventario.', 'error');
ย ย ย ย ย ย toggleAppView(false);
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Maneja el evento de selecciรณn de archivo CSV.
ยย ย ย ย */
ย ย ย ย function handleFileSelect(event) {
ย ย ย ย ย ย const file = event.target.files[0];
ย ย ย ย ย ย if (!file) return;

ย ย ย ย ย ย // Mostrar nombre del archivo
ย ย ย ย ย ย mostrarMensajeCarga(`Archivo seleccionado: ${file.name}. Procesando...`, 'success');

ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย reader.onload = function(e) {
ย ย ย ย ย ย ย ย const csvContent = e.target.result;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // 1. Parsear el nuevo contenido CSV
ย ย ย ย ย ย ย ย const newInventory = parsearCSV(csvContent);
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย if (Object.keys(newInventory).length === 0) {
ย ย ย ย ย ย ย ย ย ย mostrarMensajeCarga('El archivo CSV estรก vacรญo o el formato es incorrecto.', 'error');
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // 2. Sobrescribir el inventario, guardar y actualizar UI
ย ย ย ย ย ย ย ย inventario = newInventory;
ย ย ย ย ย ย ย ย visualStartIndex = 0; // Resetear filtro visual al cargar nuevo inventario
ย ย ย ย ย ย ย ย guardarInventario();

ย ย ย ย ย ย ย ย mostrarMensaje(`ยกInventario cargado exitosamente! ${Object.keys(inventario).length} productos inicializados.`, 'success');
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย toggleAppView(true); // Mostrar aplicaciรณn principal primero
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย renderizarTabla();
ย ย ย ย ย ย ย ย renderizarTablaVentas();
ย ย ย ย ย ย ย ย // Llamada con setTimeout para que Canvas tenga dimensiones correctas
ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย dibujarCanvasReporte();
ย ย ย ย ย ย ย ย ย ย dibujarPieChartVentas();
ย ย ย ย ย ย ย ย ย ย // Re-renderizar iconos de Lucide
ย ย ย ย ย ย ย ย ย ย if (window.lucide) {
ย ย ย ย ย ย ย ย ย ย ย ย window.lucide.createIcons();
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }, 50);ย
ย ย ย ย ย ย };
ย ย ย ย ย ย reader.onerror = function() {
ย ย ย ย ย ย ย ย mostrarMensajeCarga('Error al leer el archivo.', 'error');
ย ย ย ย ย ย };
ย ย ย ย ย ย reader.readAsText(file);
ย ย ย ย }
ยย ย ย ย
ย ย ย ย /**
ยย ย ย ย * Alterna la visibilidad entre la carga del archivo y la aplicaciรณn principal.
ยย ย ย ย */
ย ย ย ย function toggleAppView(isLoaded) {
ย ย ย ย ย ย const mainContent = document.getElementById('main-app-content');
ย ย ย ย ย ย const fileSection = document.getElementById('file-upload-card');

ย ย ย ย ย ย if (isLoaded && Object.keys(inventario).length > 0) {
ย ย ย ย ย ย ย ย fileSection.classList.add('hidden');
ย ย ย ย ย ย ย ย mainContent.classList.remove('hidden');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย fileSection.classList.remove('hidden');
ย ย ย ย ย ย ย ย mainContent.classList.add('hidden');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Guarda el objeto inventario en localStorage.
ยย ย ย ย */
ย ย ย ย function guardarInventario() {
ย ย ย ย ย ย localStorage.setItem(STORAGE_KEY, JSON.stringify(inventario));
ย ย ย ย }

ย ย ย ย // --- LรGICA DE NEGOCIO ---

ย ย ย ย /**
ยย ย ย ย * Calcula el stock disponible para un SKU dado.
ยย ย ย ย */
ย ย ย ย function calcularStockDisponible(sku) {
ย ย ย ย ย ย const p = inventario[sku];
ย ย ย ย ย ย return p ? p.stock_inicial - p.stock_vendido : 0;
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Busca y muestra la informaciรณn del producto en el รกrea de consulta.
ยย ย ย ย */
ย ย ย ย function consultarProducto(sku) {
ย ย ย ย ย ย const p = inventario[sku];
ย ย ย ย ย ย const resultadoDiv = document.getElementById('consulta-resultado');
ยย ย ย ย ย ย
ย ย ย ย ย ย if (!sku) {
ยย ย ย ย ย ย ย ย resultadoDiv.innerHTML = '<p class="text-gray-500">Consulta el estado del producto ingresando un SKU.</p>';
ยย ย ย ย ย ย ย ย return null;
ย ย ย ย ย ย }

ย ย ย ย ย ย if (!p) {
ย ย ย ย ย ย ย ย resultadoDiv.innerHTML = `<p class="text-red-600 font-semibold">โ SKU <b>${sku}</b> no encontrado en el inventario.</p>`;
ย ย ย ย ย ย ย ย return null;
ย ย ย ย ย ย }

ย ย ย ย ย ย const stockDisponible = calcularStockDisponible(sku);
ย ย ย ย ย ย const stockColor = stockDisponible <= 5 ? 'text-red-600' : 'text-[#577161]';

ย ย ย ย ย ย resultadoDiv.innerHTML = `
ย ย ย ย ย ย ย ย <p><b>Producto:</b> <span class="text-gray-900">${p.nombre}</span></p>
ย ย ย ย ย ย ย ย <p><b>Precio:</b> <span class="text-gray-900">$${p.precio_venta.toFixed(2)}</span></p>
ย ย ย ย ย ย ย ย <p><b>Stock Disponible:</b> <span class="${stockColor} font-bold text-lg">${stockDisponible} Unidades</span></p>
ย ย ย ย ย ย `;
ย ย ย ย ย ย return p;
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Registra una venta, actualiza el stock, guarda y renderiza la vista.
ยย ย ย ย */
ย ย ย ย function registrarVenta(sku) {
ย ย ย ย ย ย const p = inventario[sku];
ยย ย ย ย ย ย
ย ย ย ย ย ย if (!p) {
ย ย ย ย ย ย ย ย mostrarMensaje(`ERROR: SKU ${sku} no existe.`, 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย const stockActual = calcularStockDisponible(sku);

ย ย ย ย ย ย if (stockActual <= 0) {
ย ย ย ย ย ย ย ย mostrarMensaje(`โ VENTA BLOQUEADA: ${p.nombre} agotado. Stock: 0.`, 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย // Actualizar stock
ย ย ย ย ย ย p.stock_vendido += 1;
ย ย ย ย ย ย guardarInventario();
ยย ย ย ย ย ย
ย ย ย ย ย ย // Lรณgica de reemplazo dinรกmico para el grรกfico visual (Punto clave)
ย ย ย ย ย ย actualizarIndiceVisual(sku);

ย ย ย ย ย ย const nuevoStock = calcularStockDisponible(sku);
ย ย ย ย ย ย mostrarMensaje(`๐ Venta de ${p.nombre} registrada. Stock restante: ${nuevoStock}.`, 'success');
ยย ย ย ย ย ย
ย ย ย ย ย ย // Actualizar vistas de consulta, tablas y grรกficos
ย ย ย ย ย ย consultarProducto(sku);
ย ย ย ย ย ย renderizarTabla();
ย ย ย ย ย ย renderizarTablaVentas();
ย ย ย ย ย ย dibujarCanvasReporte();ย
ย ย ย ย ย ย dibujarPieChartVentas();
ย ย ย ย }
ยย ย ย ย
ย ย ย ย /**
ยย ย ย ย * NUEVA FUNCIรN: Actualiza el รญndice visual si el producto vendido
ยย ย ย ย * estรก en el rango visible y su stock llegรณ a cero.
ยย ย ย ย */
ย ย ย ย function actualizarIndiceVisual(skuVendido) {
ย ย ย ย ย ย const skus = Object.keys(inventario);
ย ย ย ย ย ย const indexVendido = skus.indexOf(skuVendido);

ย ย ย ย ย ย // 1. Determinar si el producto vendido estรก en el rango visible
ย ย ย ย ย ย if (indexVendido >= visualStartIndex && indexVendido < visualStartIndex + MAX_VISUAL_ITEMS) {
ย ย ย ย ย ย ย ย // 2. Verificar si su stock disponible acaba de llegar a CERO
ย ย ย ย ย ย ย ย if (calcularStockDisponible(skuVendido) === 0) {
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย // 3. Buscar el siguiente producto NO VISIBLE con stock > 0
ย ย ย ย ย ย ย ย ย ย let nextIndex = visualStartIndex + MAX_VISUAL_ITEMS;
ย ย ย ย ย ย ย ย ย ย let foundReplacement = false;
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย // Buscar en el resto del inventario
ย ย ย ย ย ย ย ย ย ย while (nextIndex < skus.length) {
ย ย ย ย ย ย ย ย ย ย ย ย if (calcularStockDisponible(skus[nextIndex]) > 0) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย foundReplacement = true;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย break;ย
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย nextIndex++;
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย // 4. Si encontramos un reemplazo y el producto vendido es el primero visible,
ย ย ย ย ย ย ย ย ย ย // O si el producto vendido es el รบltimo visible (o el que se agotรณ),
ย ย ย ย ย ย ย ย ย ย // movemos el รญndice de inicio para hacer espacio al nuevo producto.
ย ย ย ย ย ย ย ย ย ย // La forma mรกs simple de garantizar que el nuevo producto entre es:
ย ย ย ย ย ย ย ย ย ย if (foundReplacement && visualStartIndex < skus.length - MAX_VISUAL_ITEMS) {
ย ย ย ย ย ย ย ย ย ย ย ย visualStartIndex++;
ย ย ย ย ย ย ย ย ย ย ย ย mostrarMensaje(`Filtro visual avanzado: Se agotรณ un producto. Mostrando nuevo rango.`, 'success');
ย ย ย ย ย ย ย ย ย ย }
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย // Si no se encuentra reemplazo, y el รญndice estรก en 0, no hacer nada.ย
ย ย ย ย ย ย ย ย ย ย // Si el รญndice ya se moviรณ, mantendrรก el รบltimo subconjunto.
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย /**
ยย ย ย ย * Maneja la entrada del SKU y lanza la venta al presionar el botรณn o Enter.
ยย ย ย ย */
ย ย ย ย function registrarVentaDesdeInput() {
ย ย ย ย ย ย const input = document.getElementById('sku-input');
ย ย ย ย ย ย const sku = input.value.trim().toUpperCase();
ยย ย ย ย ย ย
ย ย ย ย ย ย if (!sku) {
ย ย ย ย ย ย ย ย mostrarMensaje('Por favor, ingresa un SKU vรกlido.', 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย registrarVenta(sku);
ย ย ย ย ย ย input.value = ''; // Limpiar campo despuรฉs de la venta
ย ย ย ย }

ย ย ย ย // Escuchar la tecla Enter en el campo de texto para la venta rรกpida
ย ย ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย ย ย const input = document.getElementById('sku-input');
ย ย ย ย ย ย if (input) {
ย ย ย ย ย ย ย ย // Listener para confirmar venta al presionar Enter
ย ย ย ย ย ย ย ย input.addEventListener('keydown', (event) => {
ย ย ย ย ย ย ย ย ย ย if (event.key === 'Enter') {
ย ย ย ย ย ย ย ย ย ย ย ย event.preventDefault(); // Evitar el envรญo del formulario
ย ย ย ย ย ย ย ย ย ย ย ย registrarVentaDesdeInput();
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // NUEVO: Implementaciรณn de la bรบsqueda automรกtica/consulta en tiempo real (evento 'input')
ย ย ย ย ย ย ย ย input.addEventListener('input', (event) => {
ย ย ย ย ย ย ย ย ย ย const sku = event.target.value.trim().toUpperCase();
ย ย ย ย ย ย ย ย ย ย consultarProducto(sku);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย });


ย ย ย ย // --- FUNCIONES DE RENDERIZADO Y CANVAS ---
ยย ย ย ย
ย ย ย ย /**
ยย ย ย ย * Genera colores de la paleta para el Pie Chart.
ยย ย ย ย */
ย ย ย ย function getRandomColor(index) {
ย ย ย ย ย ย // Paleta de colores mรกs moderna y coherente con el esquema verde/gris/marrรณn
ย ย ย ย ย ย const colors = [
ย ย ย ย ย ย ย ย '#577161', // Verde Olivo Oscuro
ย ย ย ย ย ย ย ย '#A5C9B3', // Verde Claro
ย ย ย ย ย ย ย ย '#86736F', // Taupe/Marrรณn Grisรกceo
ย ย ย ย ย ย ย ย '#8B959A', // Gris Medio
ย ย ย ย ย ย ย ย '#3C3231', // Marrรณn Espresso
ย ย ย ย ย ย ย ย '#6D797C', // Gris Oscuro
ย ย ย ย ย ย ย ย '#88A796', // Verde Medio
ย ย ย ย ย ย ];
ย ย ย ย ย ย return colors[index % colors.length];
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Dibuja un grรกfico circular (Pie Chart) que refleja la distribuciรณn de ingresos por producto
ยย ย ย ย * y genera la leyenda en un contenedor HTML separado.
ยย ย ย ย */
ย ย ย ย function dibujarPieChartVentas() {
ย ย ย ย ย ย const canvas = document.getElementById('ventasPieCanvas');
ย ย ย ย ย ย const totalRevenueEl = document.getElementById('total-revenue-amount'); // Modificado para el nuevo ID
ย ย ย ย ย ย const ticketPromedioEl = document.getElementById('ticket-promedio-amount'); // Nuevo elemento
ย ย ย ย ย ย const legendContainer = document.getElementById('pie-legend-container');
ยย ย ย ย ย ย
ย ย ย ย ย ย if (!canvas || !totalRevenueEl || !ticketPromedioEl || !legendContainer) return;

ย ย ย ย ย ย const ctx = canvas.getContext('2d');
ยย ย ย ย ย ย
ย ย ย ย ย ย // Usar getBoundingClientRect del contenedor padre del canvas para calcular el tamaรฑo real
ย ย ย ย ย ย const containerRect = canvas.parentElement.getBoundingClientRect();
ย ย ย ย ย ย // Estimamos el ancho para el grรกfico (excluyendo el รกrea de la leyenda)
ย ย ย ย ย ย const canvasWidth = containerRect.width;
ย ย ย ย ย ย const canvasHeight = canvas.height;ย
ยย ย ย ย ย ย
ย ย ย ย ย ย // Asegurar dimensiones correctas en el atributo del canvas
ย ย ย ย ย ย canvas.width = canvasWidth;
ย ย ย ย ย ย canvas.height = canvasHeight;
ย ย ย ย ย ย ctx.clearRect(0, 0, canvasWidth, canvasHeight);
ย ย ย ย ย ย legendContainer.innerHTML = ''; // Limpiar leyenda HTML

ย ย ย ย ย ย const salesData = Object.keys(inventario)
ย ย ย ย ย ย ย ย .map(sku => ({
ย ย ย ย ย ย ย ย ย ย nombre: inventario[sku].nombre,
ย ย ย ย ย ย ย ย ย ย revenue: inventario[sku].stock_vendido * inventario[sku].precio_venta,
ย ย ย ย ย ย ย ย ย ย items_sold: inventario[sku].stock_vendido
ย ย ย ย ย ย ย ย }))
ย ย ย ย ย ย ย ย .filter(item => item.revenue > 0);

ย ย ย ย ย ย const totalRevenue = salesData.reduce((sum, item) => sum + item.revenue, 0);
ยย ย ย ย ย ย
ย ย ย ย ย ย // --------------------------------------------------------
ย ย ย ย ย ย // 1. CรLCULO DE MรTRICAS CLAVE
ย ย ย ย ย ย // --------------------------------------------------------
ย ย ย ย ย ย const totalItemsSold = salesData.reduce((sum, item) => sum + item.items_sold, 0);

ย ย ย ย ย ย let ticketPromedio = 0;
ย ย ย ย ย ย if (totalItemsSold > 0) {
ย ย ย ย ย ย ย ย // Fรณrmula: Ingreso Total / Nรบmero de Transacciones (Unidades Vendidas)
ย ย ย ย ย ย ย ย ticketPromedio = totalRevenue / totalItemsSold;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย // --------------------------------------------------------
ย ย ย ย ย ย // 2. ACTUALIZACIรN DEL DOM DE MรTRICAS
ย ย ย ย ย ย // --------------------------------------------------------
ย ย ย ย ย ย totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
ย ย ย ย ย ย ticketPromedioEl.textContent = `$${ticketPromedio.toFixed(2)}`;
ยย ย ย ย ย ย
ย ย ย ย ย ย // Manejo de caso sin ventas para el Canvas
ย ย ย ย ย ย if (salesData.length === 0 || totalRevenue <= 0) {
ย ย ย ย ย ย ย ย // Reiniciar visualizaciones a cero
ย ย ย ย ย ย ย ย totalRevenueEl.textContent = '$0.00';
ย ย ย ย ย ย ย ย ticketPromedioEl.textContent = '$0.00';
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย legendContainer.innerHTML = '<p class="text-gray-500 text-center">Sin ventas registradas.</p>';
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Dibujar un mensaje de placeholder en el canvas
ย ย ย ย ย ย ย ย ctx.fillStyle = '#F0F0F0';
ย ย ย ย ย ย ย ย ctx.fillRect(0, 0, canvasWidth, canvasHeight);
ย ย ย ย ย ย ย ย ctx.fillStyle = '#9ca3af';
ย ย ย ย ย ย ย ย ctx.textAlign = 'center';
ย ย ย ย ย ย ย ย ctx.font = '16px Inter';
ย ย ย ย ย ย ย ย ctx.fillText('Sin datos de ventas', canvasWidth / 2, canvasHeight / 2);
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย // --------------------------------------------------------
ย ย ย ย ย ย // 3. DIBUJO DEL GRรFICO CIRCULAR
ย ย ย ย ย ย // --------------------------------------------------------

ย ย ย ย ย ย // Calcular el espacio real que debe ocupar el grรกfico circular
ย ย ย ย ย ย const graphContainerWidth = canvasWidth;ย
ย ย ย ย ย ย const centerX = graphContainerWidth * 0.45; // Centrar un poco a la izquierdaย
ย ย ย ย ย ย const centerY = canvasHeight / 2;
ย ย ย ย ย ย const radius = Math.max(0, Math.min(centerX, centerY) - 10);ย
ยย ย ย ย ย ย
ย ย ย ย ย ย if (radius === 0) return;ย

ย ย ย ย ย ย let currentAngle = 0;
ยย ย ย ย ย ย
ย ย ย ย ย ย // --- DIBUJAR GRรFICO ---
ย ย ย ย ย ย salesData.forEach((item, index) => {
ย ย ย ย ย ย ย ย const sliceAngle = (item.revenue / totalRevenue) * 2 * Math.PI;
ย ย ย ย ย ย ย ย if (!isFinite(sliceAngle)) return;ย
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย const startAngle = currentAngle;
ย ย ย ย ย ย ย ย const endAngle = currentAngle + sliceAngle;
ย ย ย ย ย ย ย ย const color = getRandomColor(index);
ย ย ย ย ย ย ย ย const percentage = (item.revenue / totalRevenue) * 100;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Draw Pie Slice
ย ย ย ย ย ย ย ย ctx.beginPath();
ย ย ย ย ย ย ย ย ctx.moveTo(centerX, centerY);
ย ย ย ย ย ย ย ย ctx.arc(centerX, centerY, radius, startAngle, endAngle);ย
ย ย ย ย ย ย ย ย ctx.closePath();
ย ย ย ย ย ย ย ย ctx.fillStyle = color;
ย ย ย ย ย ย ย ย ctx.fill();

ย ย ย ย ย ย ย ย // Draw Slice Border
ย ย ย ย ย ย ย ย ctx.strokeStyle = '#F7F7F7';
ย ย ย ย ย ย ย ย ctx.lineWidth = 2;
ย ย ย ย ย ย ย ย ctx.stroke();

ย ย ย ย ย ย ย ย // Draw Percentage Label (only for slices > 5%)
ย ย ย ย ย ย ย ย const midAngle = startAngle + sliceAngle / 2;
ย ย ย ย ย ย ย ย const labelRadius = radius * 0.8;
ย ย ย ย ย ย ย ย const labelX = centerX + labelRadius * Math.cos(midAngle);
ย ย ย ย ย ย ย ย const labelY = centerY + labelRadius * Math.sin(midAngle);
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย if (percentage > 5) {
ย ย ย ย ย ย ย ย ย ย ctx.fillStyle = 'white';
ย ย ย ย ย ย ย ย ย ย ctx.font = 'bold 12px Inter';
ย ย ย ย ย ย ย ย ย ย ctx.textAlign = 'center';
ย ย ย ย ย ย ย ย ย ย ctx.fillText(`${percentage.toFixed(0)}%`, labelX, labelY);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // --- CREAR LEYENDA HTML (para el contenedor de la derecha) ---
ย ย ย ย ย ย ย ย const legendItem = document.createElement('div');
ย ย ย ย ย ย ย ย legendItem.className = 'flex items-center justify-between text-gray-700';
ย ย ย ย ย ย ย ย legendItem.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <div class="flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></span>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="truncate">${item.nombre}</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <span class="font-semibold text-[#577161]">${percentage.toFixed(1)}%</span>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย legendContainer.appendChild(legendItem);

ย ย ย ย ย ย ย ย currentAngle = endAngle;
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Dibuja un grรกfico de barras simple en el elemento CANVAS (Stock Disponible).
ยย ย ย ย * **FILTRADO:** Solo dibuja MAX_VISUAL_ITEMS (10) productos desde visualStartIndex.
ยย ย ย ย */
ย ย ย ย function dibujarCanvasReporte() {
ย ย ย ย ย ย const canvas = document.getElementById('stockCanvas');
ย ย ย ย ย ย if (!canvas) return;
ย ย ย ย ย ย const ctx = canvas.getContext('2d');
ยย ย ย ย ย ย
ย ย ย ย ย ย const canvasWidth = canvas.clientWidth;
ย ย ย ย ย ย const canvasHeight = canvas.clientHeight;

ย ย ย ย ย ย // Seguridad: Verificar que el canvas tiene un tamaรฑo visible antes de dibujar
ย ย ย ย ย ย if (canvasWidth === 0 || canvasHeight === 0) {
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย canvas.width = canvasWidth;
ย ย ย ย ย ย canvas.height = canvasHeight;
ยย ย ย ย ย ย
ย ย ย ย ย ย ctx.clearRect(0, 0, canvasWidth, canvasHeight);
ยย ย ย ย ย ย
ย ย ย ย ย ย const skus = Object.keys(inventario);
ย ย ย ย ย ย if (skus.length === 0) return;

ย ย ย ย ย ย // --- APLICAR FILTRO DE 10 PRODUCTOS ---
ย ย ย ย ย ย const displayedSkus = skus.slice(visualStartIndex, visualStartIndex + MAX_VISUAL_ITEMS);

ย ย ย ย ย ย // 1. Actualizar el mensaje del filtro
ย ย ย ย ย ย const startDisplay = visualStartIndex + 1;
ย ย ย ย ย ย let endDisplay = visualStartIndex + displayedSkus.length;
ย ย ย ย ย ย if (endDisplay > skus.length) endDisplay = skus.length; // Ajustar si es el final
ยย ย ย ย ย ย
ย ย ย ย ย ย const infoText = `Mostrando productos ${startDisplay}-${endDisplay} de ${skus.length}.`;
ย ย ย ย ย ย const filterInfoEl = document.getElementById('visual-filter-info');
ย ย ย ย ย ย if(filterInfoEl) filterInfoEl.textContent = infoText;

ย ย ย ย ย ย // 2. Preparar los datos filtrados
ย ย ย ย ย ย const data = displayedSkus.map(sku => ({
ย ย ย ย ย ย ย ย sku: sku,
ย ย ย ย ย ย ย ย stock: calcularStockDisponible(sku)
ย ย ย ย ย ย }));
ยย ย ย ย ย ย
ย ย ย ย ย ย const margin = 15;
ย ย ย ย ย ย const labelMargin = 25;ย
ย ย ย ย ย ย const plotHeight = canvasHeight - margin * 2 - labelMargin;
ย ย ย ย ย ย const plotWidth = canvasWidth - margin * 2;
ย ย ย ย ย ย const maxStock = Math.max(...data.map(d => d.stock), 1);ย

ย ย ย ย ย ย ctx.font = '11px Inter';
ย ย ย ย ย ย ctx.textAlign = 'center';
ยย ย ย ย ย ย
ย ย ย ย ย ย const totalItems = data.length;
ย ย ย ย ย ย // Asegurar que solo se dibujan 10 barras
ย ย ย ย ย ย const barWidth = (plotWidth / MAX_VISUAL_ITEMS) * 0.6;ย
ย ย ย ย ย ย const spacing = (plotWidth / MAX_VISUAL_ITEMS) * 0.4;ย

ย ย ย ย ย ย data.forEach((item, index) => {
ย ย ย ย ย ย ย ย // Posiciรณn X basada en el รญndice dentro del subconjunto (0 a 9)
ย ย ย ย ย ย ย ย const x = margin + index * (barWidth + spacing) + spacing / 2;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Asegurar que la altura es al menos 1px si hay stock para visibilidad
ย ย ย ย ย ย ย ย const rawBarHeight = (item.stock / maxStock) * plotHeight;
ย ย ย ย ย ย ย ย const barHeight = item.stock > 0 ? Math.max(1, rawBarHeight) : 0;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Dibujar barra
ย ย ย ย ย ย ย ย const color = item.stock <= 5 && item.stock > 0 ? '#EF4444' : (item.stock === 0 ? '#B0B0B0' : '#577161'); /* Rojo, Gris Agotado, o Verde primario */
ย ย ย ย ย ย ย ย ctx.fillStyle = color;
ย ย ย ย ย ย ย ย ctx.fillRect(x, canvasHeight - margin - labelMargin - barHeight, barWidth, barHeight);
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Dibujar valor (stock)
ย ย ย ย ย ย ย ย ctx.fillStyle = '#3C3231';
ย ย ย ย ย ย ย ย ctx.font = 'bold 12px Inter';
ย ย ย ย ย ย ย ย // Solo dibujar el valor si el stock es mayor a 0, o si es 0, dibujarlo abajo
ย ย ย ย ย ย ย ย if (item.stock > 0) {
ย ย ย ย ย ย ย ย ย ย ctx.fillText(item.stock, x + barWidth / 2, canvasHeight - margin - labelMargin - barHeight - 5);
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ctx.fillStyle = '#B0B0B0';
ย ย ย ย ย ย ย ย ย ย ctx.fillText('0', x + barWidth / 2, canvasHeight - margin - labelMargin - 50);
ย ย ย ย ย ย ย ย }
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Dibujar etiqueta (SKU)
ย ย ย ย ย ย ย ย ctx.fillStyle = '#6D797C';
ย ย ย ย ย ย ย ย ctx.font = '11px Inter';
ย ย ย ย ย ย ย ย ctx.fillText(item.sku, x + barWidth / 2, canvasHeight - margin - 5);
ย ย ย ย ย ย });

ย ย ย ย ย ย // Dibujar eje X (lรญnea base)
ย ย ย ย ย ย ctx.beginPath();
ย ย ย ย ย ย ctx.moveTo(margin, canvasHeight - margin - labelMargin);
ย ย ย ย ย ย ctx.lineTo(canvasWidth - margin, canvasHeight - margin - labelMargin);
ย ย ย ย ย ย ctx.strokeStyle = '#D1D5DB';
ย ย ย ย ย ย ctx.lineWidth = 1;
ย ย ย ย ย ย ctx.stroke();
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Renderiza la tabla de productos vendidos (ahora mรกs compacta).
ยย ย ย ย */
ย ย ย ย function renderizarTablaVentas() {
ย ย ย ย ย ย const tbody = document.querySelector('#ventas-tabla tbody');
ย ย ย ย ย ย if (!tbody) return;
ย ย ย ย ย ย tbody.innerHTML = '';ย
ยย ย ย ย ย ย
ย ย ย ย ย ย const skus = Object.keys(inventario);

ย ย ย ย ย ย skus.forEach(sku => {
ย ย ย ย ย ย ย ย const p = inventario[sku];
ย ย ย ย ย ย ย ย const vendidos = p.stock_vendido;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย if (vendidos > 0) {
ย ย ย ย ย ย ย ย ย ย const revenue = vendidos * p.precio_venta;

ย ย ย ย ย ย ย ย ย ย const row = tbody.insertRow();
ย ย ย ย ย ย ย ย ย ย row.classList.add('hover:bg-gray-100');

ย ย ย ย ย ย ย ย ย ย // Celdas (solo Producto, Cant. y Total)
ย ย ย ย ย ย ย ย ย ย row.insertCell().textContent = p.nombre;
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย const vendidosCell = row.insertCell();
ย ย ย ย ย ย ย ย ย ย vendidosCell.textContent = vendidos;
ย ย ย ย ย ย ย ย ย ย vendidosCell.classList.add('text-right');

ย ย ย ย ย ย ย ย ย ย // Columna Total
ย ย ย ย ย ย ย ย ย ย const totalCell = row.insertCell();
ย ย ย ย ย ย ย ย ย ย totalCell.innerHTML = `<span class="font-bold text-[#577161]">$${revenue.toFixed(2)}</span>`;
ย ย ย ย ย ย ย ย ย ย totalCell.classList.add('text-right');
ยย ย ย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย ย ย // Aplicar estilos de Tailwind a las celdas
ย ย ย ย ย ย ย ย ย ย Array.from(row.cells).forEach(cell => cell.classList.add('px-3', 'py-2', 'whitespace-nowrap', 'text-sm'));
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Renderiza la tabla de inventario en el HTML.
ยย ย ย ย */
ย ย ย ย function renderizarTabla() {
ย ย ย ย ย ย const tbody = document.querySelector('#inventario-tabla tbody');
ย ย ย ย ย ย if (!tbody) return;
ย ย ย ย ย ย tbody.innerHTML = '';ย
ย ย ย ย ย ย const skus = Object.keys(inventario);
ย ย ย ย ย ย const emptyMessage = document.getElementById('empty-message');

ย ย ย ย ย ย if (skus.length === 0) {
ย ย ย ย ย ย ย ย emptyMessage.classList.remove('hidden');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย emptyMessage.classList.add('hidden');

ย ย ย ย ย ย skus.forEach(sku => {
ย ย ย ย ย ย ย ย const p = inventario[sku];
ย ย ย ย ย ย ย ย const stockDisponible = calcularStockDisponible(sku);
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย const row = tbody.insertRow();
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Estilo de fila segรบn el stock
ย ย ย ย ย ย ย ย if (stockDisponible <= 5 && stockDisponible > 0) {
ย ย ย ย ย ย ย ย ย ย row.classList.add('bg-yellow-50', 'hover:bg-yellow-100');ย
ย ย ย ย ย ย ย ย } else if (stockDisponible === 0) {
ยย ย ย ย ย ย ย ย ย ย row.classList.add('bg-red-50', 'hover:bg-red-100');ย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย row.classList.add('hover:bg-gray-50');
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // Celdas
ย ย ย ย ย ย ย ย row.insertCell().textContent = sku;
ย ย ย ย ย ย ย ย row.insertCell().textContent = p.nombre;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย const inicialCell = row.insertCell();
ย ย ย ย ย ย ย ย inicialCell.textContent = p.stock_inicial;
ย ย ย ย ย ย ย ย inicialCell.classList.add('text-right');
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย const vendidoCell = row.insertCell();
ย ย ย ย ย ย ย ย vendidoCell.textContent = p.stock_vendido;
ย ย ย ย ย ย ย ย vendidoCell.classList.add('text-right');
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Columna de Stock Disponible (resaltada)
ย ย ย ย ย ย ย ย const dispCell = row.insertCell();
ย ย ย ย ย ย ย ย const stockColor = stockDisponible <= 5 ? 'text-red-600' : 'text-[#577161]';
ย ย ย ย ย ย ย ย dispCell.innerHTML = `<span class="font-bold ${stockColor} text-base">${stockDisponible}</span>`;
ย ย ย ย ย ย ย ย dispCell.classList.add('text-right');
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย const precioCell = row.insertCell();
ย ย ย ย ย ย ย ย precioCell.textContent = `$${p.precio_venta.toFixed(2)}`;
ย ย ย ย ย ย ย ย precioCell.classList.add('text-right');
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Aplicar estilos de Tailwind a las celdas
ย ย ย ย ย ย ย ย Array.from(row.cells).forEach(cell => cell.classList.add('px-6', 'py-3', 'whitespace-nowrap', 'text-sm'));
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Muestra un mensaje temporal en el รกrea de Venta/Consulta.
ยย ย ย ย */
ย ย ย ย function mostrarMensaje(texto, tipo) {
ย ย ย ย ย ย const div = document.getElementById('mensaje');
ย ย ย ย ย ย if (!div) return;
ย ย ย ย ย ย div.className = `message-box mt-5 p-4 rounded-xl font-medium transition duration-300 ${tipo}`;
ย ย ย ย ย ย div.textContent = texto;
ยย ย ย ย ย ย
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย div.textContent = '';
ย ย ย ย ย ย ย ย div.className = 'message-box mt-5 p-4 rounded-xl font-medium';
ย ย ย ย ย ย }, 3500);
ย ย ย ย }
ยย ย ย ย
ย ย ย ย /**
ยย ย ย ย * Muestra un mensaje temporal en el รกrea de Carga de Archivo.
ยย ย ย ย */
ย ย ย ย function mostrarMensajeCarga(texto, tipo) {
ย ย ย ย ย ย const div = document.getElementById('mensaje-carga');
ย ย ย ย ย ย if (!div) return;
ย ย ย ย ย ย div.className = `message-box mt-5 p-4 rounded-xl font-medium transition duration-300 ${tipo}`;
ย ย ย ย ย ย div.textContent = texto;
ยย ย ย ย ย ย
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย div.textContent = '';
ย ย ย ย ย ย ย ย div.className = 'message-box mt-5 p-4 rounded-xl font-medium';
ย ย ย ย ย ย }, 5000);
ย ย ย ย }
ยย ย ย ย
ย ย ย ย // --- FUNCIONES DE MODAL DE CONTRASEรA Y EXPORTACIรN ---

ย ย ย ย /**
ยย ย ย ย * Muestra el modal para solicitar la contraseรฑa antes de exportar.
ยย ย ย ย */
ย ย ย ย function mostrarModalContrasena() {
ย ย ย ย ย ย const modal = document.getElementById('password-modal');
ย ย ย ย ย ย const passwordInput = document.getElementById('password-input');
ย ย ย ย ย ย const errorMessage = document.getElementById('modal-error-message');
ยย ย ย ย ย ย
ย ย ย ย ย ย if (Object.keys(inventario).length === 0) {
ย ย ย ย ย ย ย ย mostrarMensaje('No hay datos en el inventario para exportar.', 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ยย ย ย ย ย ย
ย ย ย ย ย ย errorMessage.classList.add('hidden');
ย ย ย ย ย ย passwordInput.value = '';
ย ย ย ย ย ย modal.classList.remove('hidden');
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Oculta el modal de contraseรฑa.
ยย ย ย ย */
ย ย ย ย function ocultarModalContrasena() {
ย ย ย ย ย ย const modal = document.getElementById('password-modal');
ย ย ย ย ย ย modal.classList.add('hidden');
ย ย ย ย }

ย ย ย ย /**
ยย ย ย ย * Verifica la contraseรฑa e inicia la exportaciรณn.
ยย ย ย ย */
ย ย ย ย function verificarContrasenaExportar() {
ย ย ย ย ย ย const passwordInput = document.getElementById('password-input');
ย ย ย ย ย ย const enteredPassword = passwordInput.value.trim();
ย ย ย ย ย ย const errorMessage = document.getElementById('modal-error-message');
ยย ย ย ย ย ย
ย ย ย ย ย ย if (enteredPassword === CORRECT_PASSWORD) {
ย ย ย ย ย ย ย ย ocultarModalContrasena();
ย ย ย ย ย ย ย ย exportarInventarioPDF();
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย errorMessage.textContent = 'Contraseรฑa incorrecta. Intรฉntalo de nuevo.';
ย ย ย ย ย ย ย ย errorMessage.classList.remove('hidden');
ย ย ย ย ย ย ย ย passwordInput.value = '';
ย ย ย ย ย ย ย ย passwordInput.focus();
ย ย ย ย ย ย }
ย ย ย ย }
ยย ย ย ย
ย ย ย ย /**
ยย ย ย ย * Genera un reporte PDF de la tabla de inventario *directamente*
ยย ย ย ย * utilizando jsPDF y el plugin AutoTable para calidad vectorial.
ยย ย ย ย */
ย ย ย ย function exportarInventarioPDF() {
ย ย ย ย ย ย // Usamos la librerรญa window.jspdf ya cargada
ย ย ย ย ย ย const { jsPDF } = window.jspdf;
ยย ย ย ย ย ย
ย ย ย ย ย ย mostrarMensaje('Generando reporte PDF vectorial... Por favor espera.', 'success');

ย ย ย ย ย ย // 1. Inicializar jsPDF
ย ย ย ย ย ย const doc = new jsPDF('p', 'mm', 'a4'); // 'p' = portrait, 'mm' = milimetros

ย ย ย ย ย ย // 2. Tรญtulo y Metadatos (Vectoriales)
ย ย ย ย ย ย doc.setFontSize(18);
ย ย ย ย ย ย doc.text("Reporte de Inventario SKU en Tiempo Real", 105, 15, null, null, "center");
ยย ย ย ย ย ย
ย ย ย ย ย ย doc.setFontSize(10);
ย ย ย ย ย ย doc.text(`Fecha de Exportaciรณn: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 10, 25);
ยย ย ย ย ย ย
ย ย ย ย ย ย // 3. Preparar Datos para AutoTable
ย ย ย ย ย ย const headers = [
ย ย ย ย ย ย ย ย ['SKU', 'Nombre', 'Stock Inicial', 'Vendido', 'Stock Disponible', 'Precio Venta']
ย ย ย ย ย ย ];
ยย ย ย ย ย ย
ย ย ย ย ย ย const tableData = Object.keys(inventario).map(sku => {
ย ย ย ย ย ย ย ย const p = inventario[sku];
ย ย ย ย ย ย ย ย const stockDisponible = calcularStockDisponible(sku);
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย // Formatear el precio con el sรญmbolo $
ย ย ย ย ย ย ย ย const precioFormateado = `$${p.precio_venta.toFixed(2)}`;
ยย ย ย ย ย ย ย ย
ย ย ย ย ย ย ย ย return [
ย ย ย ย ย ย ย ย ย ย sku,ย
ย ย ย ย ย ย ย ย ย ย p.nombre,ย
ย ย ย ย ย ย ย ย ย ย p.stock_inicial,ย
ย ย ย ย ย ย ย ย ย ย p.stock_vendido,ย
ย ย ย ย ย ย ย ย ย ย stockDisponible,
ย ย ย ย ย ย ย ย ย ย precioFormateado
ย ย ย ย ย ย ย ย ];
ย ย ย ย ย ย });

ย ย ย ย ย ย // 4. Generar la tabla usando AutoTable
ย ย ย ย ย ย // Nota: El plugin autotable (ya cargado) se adjunta a la instancia de jspdf.
ย ย ย ย ย ย doc.autoTable({
ย ย ย ย ย ย ย ย startY: 35, // Comenzar debajo del encabezado
ย ย ย ย ย ย ย ย head: headers,
ย ย ย ย ย ย ย ย body: tableData,
ย ย ย ย ย ย ย ย theme: 'striped', // Un tema limpio y profesional
ย ย ย ย ย ย ย ย styles: {ย
ย ย ย ย ย ย ย ย ย ย fontSize: 9,
ย ย ย ย ย ย ย ย ย ย cellPadding: 3,
ย ย ย ย ย ย ย ย ย ย halign: 'center' // Centrar el contenido de las celdas por defecto
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย headStyles: {
ย ย ย ย ย ย ย ย ย ย fillColor: [87, 113, 97], // #577161 - Nuestro color primario verde
ย ย ย ย ย ย ย ย ย ย textColor: [255, 255, 255],
ย ย ย ย ย ย ย ย ย ย fontStyle: 'bold'
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย columnStyles: {
ย ย ย ย ย ย ย ย ย ย // Sobrescribir la alineaciรณn para las columnas de texto y nรบmeros
ย ย ย ย ย ย ย ย ย ย 0: { halign: 'left', cellWidth: 20 }, // SKU
ย ย ย ย ย ย ย ย ย ย 1: { halign: 'left', cellWidth: 45 }, // Nombre
ย ย ย ย ย ย ย ย ย ย 2: { halign: 'right' }, // Stock Inicial
ย ย ย ย ย ย ย ย ย ย 3: { halign: 'right' }, // Vendido
ย ย ย ย ย ย ย ย ย ย 4: { halign: 'right', fontStyle: 'bold' }, // Disponible (resaltado)
ย ย ย ย ย ย ย ย ย ย 5: { halign: 'right' } // Precio Venta
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย didDrawPage: function (data) {
ย ย ย ย ย ย ย ย ย ย // Pie de pรกgina (ej. nรบmero de pรกgina)
ย ย ย ย ย ย ย ย ย ย doc.setFontSize(8);
ย ย ย ย ย ย ย ย ย ย const pageCount = doc.internal.getNumberOfPages();
ย ย ย ย ย ย ย ย ย ย doc.text("Pรกgina " + doc.internal.getCurrentPageInfo().pageNumber + " de " + pageCount, data.settings.margin.left, doc.internal.pageSize.height - 5);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย // 5. Descargar el PDF
ย ย ย ย ย ย doc.save(`Reporte_Inventario_Vectorial_${new Date().toISOString().slice(0, 10)}.pdf`);
ย ย ย ย ย ย mostrarMensaje('โ Reporte PDF generado y descargado (Calidad Vectorial).', 'success');
ย ย ย ย }


ย ย ย ย // --- INICIALIZACIรN ---
ย ย ย ย window.onload = () => {
ย ย ย ย ย ย // 1. Asignar el listener de cambio al input de archivo
ย ย ย ย ย ย const fileInput = document.getElementById('csv-file-input');
ย ย ย ย ย ย if (fileInput) {
ย ย ย ย ย ย ย ย fileInput.addEventListener('change', handleFileSelect);
ย ย ย ย ย ย }
ยย ย ย ย ย ย
ย ย ย ย ย ย // 2. Intentar cargar el inventario guardado (llama a render/draw si tiene รฉxito)
ย ย ย ย ย ย cargarInventario();
ยย ย ย ย ย ย
ย ย ย ย ย ย // 3. Configurar evento de resizeย
ย ย ย ย ย ย window.addEventListener('resize', () => {
ย ย ย ย ย ย ย ย dibujarCanvasReporte();
ย ย ย ย ย ย ย ย dibujarPieChartVentas();
ย ย ย ย ย ย });
ย ย ย ย };
ย ย </script>
</body>
</html>



